# å·¥ä½œæµåç§°ï¼šä¸‹è½½FFmpeg + ä¾æ¬¡è¿è¡Œ HB â†’ DL â†’ PX è„šæœ¬
name: ä¸‹è½½FFmpeg + ä¸€é”®è”åŠ¨ HB/DL/PX
# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨åœ¨GitHub Actionsé¡µé¢ç‚¹å‡»è¿è¡Œ
on:
  workflow_dispatch:

jobs:
  run-scripts-sequentially:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šå…‹éš†ä»“åº“åˆ°äº‘ç«¯ç¯å¢ƒï¼ˆä»“åº“æ ¹ç›®å½•ï¼š/home/runner/work/iptvz/iptvz/ï¼‰
      - name: å…‹éš†iptvzä»“åº“åˆ°äº‘ç«¯
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šé…ç½®Python 3.11ç¯å¢ƒï¼ˆå’Œè„šæœ¬å…¼å®¹ï¼Œç¼“å­˜æé€Ÿï¼‰
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # æ­¥éª¤3ï¼šä»Releaseä¸‹è½½FFmpegå‹ç¼©åŒ…å¹¶è§£å‹åˆ°ä»“åº“æ ¹ç›®å½•
      - name: ä»Releaseä¸‹è½½å¹¶è§£å‹FFmpeg
        env:
          # ========== éœ€æ‰‹åŠ¨ä¿®æ”¹ï¼ï¼ï¼==========
          RELEASE_TAG: "ffmpeg-20260128"  # ä½ çš„Releaseæ ‡ç­¾åï¼ˆæ¯”å¦‚ffmpeg-static/v1.0ï¼‰
          FFMPEG_FILE: "ffmpeg-master-latest-linux64-lgpl.tar.xz"  # Releaseä¸­çš„FFmpegå‹ç¼©åŒ…æ–‡ä»¶å
          # ====================================
          REPO_URL: ${{ github.repository }}  # è‡ªåŠ¨è·å–ä½ çš„ä»“åº“åœ°å€ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
        run: |
          echo "====================================="
          echo "ğŸš€ å¼€å§‹ä»Releaseä¸‹è½½FFmpegï¼š$FFMPEG_FILE"
          echo "====================================="
          # ä¸‹è½½å‘½ä»¤ï¼šä»GitHub Releaseä¸‹è½½å‹ç¼©åŒ…åˆ°ä»“åº“æ ¹ç›®å½•
          wget --no-verbose -O $FFMPEG_FILE https://github.com/$REPO_URL/releases/download/$RELEASE_TAG/$FFMPEG_FILE
          
          echo "âœ… FFmpegä¸‹è½½å®Œæˆï¼Œå¼€å§‹è§£å‹åˆ°ä»“åº“æ ¹ç›®å½•..."
          # é€‚é…tar.gzæ ¼å¼ï¼ˆæ¨èï¼‰ï¼Œå¦‚æœç”¨zipåˆ™æ›¿æ¢ä¸ºï¼šunzip -q $FFMPEG_FILE -d .
          tar -zxf $FFMPEG_FILE -C .
          
          # éªŒè¯è§£å‹ç»“æœï¼šæ£€æŸ¥æ˜¯å¦ç”Ÿæˆffmpeg/bin/ffprobe
          if [ -f "./ffmpeg/bin/ffprobe" ] && [ -f "./ffmpeg/bin/ffmpeg" ]; then
            echo "âœ… FFmpegè§£å‹æˆåŠŸï¼Œè·¯å¾„ï¼š./ffmpeg/"
          else
            echo "âŒ FFmpegè§£å‹å¤±è´¥ï¼Œæœªæ‰¾åˆ°./ffmpeg/bin/ffprobe"
            exit 1  # è§£å‹å¤±è´¥ï¼Œç»ˆæ­¢åç»­æ­¥éª¤
          fi

      # æ­¥éª¤4ï¼šç»™FFmpeg/ffprobeæ·»åŠ å¯æ‰§è¡Œæƒé™ï¼ˆå…³é”®ï¼Œé¿å…DL.pyè¿è¡ŒæŠ¥é”™ï¼‰
      - name: ç»™ffmpeg/ffprobeæ·»åŠ å¯æ‰§è¡Œæƒé™
        run: |
          chmod -R +x ./ffmpeg/bin/
          echo "âœ… å·²ç»™ffmpeg/ffprobeæ·»åŠ å¯æ‰§è¡Œæƒé™"
          # éªŒè¯æƒé™
          if [ -x "./ffmpeg/bin/ffprobe" ]; then
            echo "âœ… ffprobeæƒé™éªŒè¯é€šè¿‡"
          else
            echo "âŒ ffprobeæ·»åŠ æƒé™å¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤5ï¼šè¿è¡ŒHB.pyï¼Œç”ŸæˆHB.txtï¼ˆä»“åº“æ ¹ç›®å½•ï¼‰
      - name: ç¬¬ä¸€æ­¥è¿è¡Œ HB.py
        run: |
          echo "====================================="
          echo "ğŸš€ å¼€å§‹è¿è¡Œ HB.pyï¼Œç”Ÿæˆ HB.txt"
          echo "====================================="
          python HB.py

      # æ­¥éª¤6ï¼šè¿è¡ŒDL.pyï¼ˆæ–­æµæ£€æµ‹ï¼‰ï¼Œè¯»å–HB.txtç”ŸæˆDL.txt
      - name: ç¬¬äºŒæ­¥è¿è¡Œ DL.py
        run: |
          echo "====================================="
          echo "ğŸš€ å¼€å§‹è¿è¡Œ DL.pyï¼Œè¯»å– HB.txt ç”Ÿæˆ DL.txt"
          echo "====================================="
          python DL.py

      # æ­¥éª¤7ï¼šè¿è¡ŒPX.pyï¼Œè¯»å–DL.txtå®Œæˆåç»­å¤„ç†
      - name: ç¬¬ä¸‰æ­¥è¿è¡Œ PX.py
        run: |
          echo "====================================="
          echo "ğŸš€ å¼€å§‹è¿è¡Œ PX.pyï¼Œè¯»å– DL.txt æ‰§è¡Œåç»­é€»è¾‘"
          echo "====================================="
          python PX.py
