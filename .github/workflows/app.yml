name: app
# 触发方式：定时（UTC23点、6点）+ 手动触发（Actions页面点击运行）
on:
  schedule:
    - cron: '0 23,6 * * *'
  workflow_dispatch:

jobs:
  run-all-scripts-sequentially:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：克隆仓库（拉取完整历史，为最终推送TV.txt做准备）
      - name: 克隆iptvz仓库到云端
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      # 步骤2：配置Python 3.11环境（全脚本统一环境）
      - name: 配置Python 3.11环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 步骤3：安装依赖（zubo.py需要的requests，全脚本通用）
      - name: 安装Python依赖库（requests）
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "✅ requests依赖安装完成，版本：$(pip show requests | grep Version | cut -d ' ' -f 2)"

      # 步骤4：运行zubo.py，生成电信.txt等中间文件（不推送）
      - name: 第一步 运行zubo.py 获取组播源
        run: |
          cd $GITHUB_WORKSPACE
          echo "📁 确认ip配置文件存在："
          ls -l ip/
          echo "====================================="
          echo "🚀 开始运行zubo.py，生成电信.txt等中间文件"
          echo "====================================="
          # 10分钟超时 + 强制实时日志，避免海外环境卡住/无输出
          timeout 10m python -u ./zubo.py
        timeout-minutes: 12  # 步骤级双重超时保护

      # 步骤5：从仓库Release下载FFmpeg并解压（DL.py断流检测必备）
      - name: 下载并解压FFmpeg（DL.py依赖）
        env:
          # ========== 需确认！和你Release中的信息一致即可，无需改 ==========
          RELEASE_TAG: "ffmpeg-20260128"  # 你的FFmpeg Release标签名
          FFMPEG_FILE: "ffmpeg-master-latest-linux64-lgpl.tar.xz"  # Release中的压缩包名
          # ===============================================================
          REPO_URL: ${{ github.repository }}  # 自动获取仓库地址，无需修改
        run: |
          echo "====================================="
          echo "🚀 开始从Release下载FFmpeg：$FFMPEG_FILE"
          echo "====================================="
          # 下载FFmpeg压缩包到仓库根目录
          wget --no-verbose -O $FFMPEG_FILE https://github.com/$REPO_URL/releases https://github.com/$REPO_URL/releases/download/$RELEASE_TAG/$FFMPEG_FILE
          
          echo "✅ FFmpeg下载完成，开始解压.tar.xz格式..."
          tar -Jxf $FFMPEG_FILE
          # 自动获取解压后的原文件夹名，适配任意命名
          FFMPEG_OLD_DIR=$(tar -tf $FFMPEG_FILE | head -1 | cut -d '/' -f 1)
          # 重命名为ffmpeg，匹配DL.py的路径要求
          mv $FFMPEG_OLD_DIR ffmpeg
          
          # 验证解压结果：必须存在ffmpeg/bin/ffprobe和ffmpeg
          if [ -f "./ffmpeg/bin/ffprobe" ] && [ -f "./ffmpeg/bin/ffmpeg" ]; then
            echo "✅ FFmpeg解压+重命名成功，路径：./ffmpeg/"
          else
            echo "❌ FFmpeg解压失败，未找到核心文件！"
            exit 1
          fi

      # 步骤6：给FFmpeg/ffprobe添加可执行权限（避免DL.py运行权限报错）
      - name: 给FFmpeg/ffprobe添加可执行权限
        run: |
          chmod -R +x ./ffmpeg/bin/
          echo "✅ 已给ffmpeg/ffprobe添加可执行权限"
          # 验证权限有效性
          if [ -x "./ffmpeg/bin/ffprobe" ]; then
            echo "✅ ffprobe权限验证通过"
          else
            echo "❌ ffprobe权限添加失败，终止运行"
            exit 1
          fi

      # 步骤7：运行HB.py，读取zubo生成的文件，生成HB.txt
      - name: 第二步 运行HB.py 生成HB.txt
        run: |
          echo "====================================="
          echo "🚀 开始运行HB.py，生成HB.txt"
          echo "====================================="
          python -u HB.py  # -u 强制实时日志，方便查看运行状态

      # 步骤8：运行DL.py，读取HB.txt，断流检测生成DL.txt
      - name: 第三步 运行DL.py 生成DL.txt
        run: |
          echo "====================================="
          echo "🚀 开始运行DL.py，断流检测生成DL.txt"
          echo "====================================="
          python -u DL.py  # -u 强制实时日志，查看断流检测过程

      # 步骤9：运行PX.py，读取DL.txt，最终生成TV.txt
      - name: 第四步 运行PX.py 生成最终TV.txt
        run: |
          echo "====================================="
          echo "🚀 开始运行PX.py，生成最终TV.txt"
          echo "====================================="
          python -u PX.py  # -u 强制实时日志，确认TV.txt生成

      # 步骤10：核心！仅提交TV.txt并推送到iptvz仓库（中间文件不推送）
      - name: 仅推送PX生成的TV.txt到仓库
        run: |
          # 配置Git提交用户信息
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # 仅添加TV.txt，精准推送，其余中间文件不提交
          git add TV.txt
          # 判断是否有文件更改，无更改则跳过提交（避免空提交报错）
          if git diff --cached --quiet; then
            echo "ℹ️  TV.txt无内容更改，跳过提交推送"
          else
            git commit -m "全自动更新：zubo→HB→DL→PX生成最新TV.txt"
            git push
            echo "✅ 最新TV.txt已成功推送到iptvz仓库！"
          fi
